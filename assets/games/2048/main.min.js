function KeyboardInputManager(){this.events={},window.navigator.msPointerEnabled?(this.eventTouchstart="MSPointerDown",this.eventTouchmove="MSPointerMove",this.eventTouchend="MSPointerUp"):(this.eventTouchstart="touchstart",this.eventTouchmove="touchmove",this.eventTouchend="touchend"),this.listen()}function HTMLActuator(){this.tileContainer=document.querySelector(".tile-container"),this.scoreContainer=document.querySelector(".score-container"),this.bestContainer=document.querySelector(".best-container"),this.messageContainer=document.querySelector(".game-message"),this.score=0}function Grid(e,t){this.size=e,this.cells=t?this.fromState(t):this.empty()}function Tile(e,t){this.x=e.x,this.y=e.y,this.value=t||2,this.previousPosition=null,this.mergedFrom=null}function LocalStorageManager(){this.bestScoreKey="bestScore",this.gameStateKey="gameState";var e=this.localStorageSupported();this.storage=e?window.localStorage:window.fakeStorage}function GameManager(e,t,i,n){this.size=e,this.inputManager=new t,this.storageManager=new n,this.actuator=new i,this.startTiles=2,this.inputManager.on("move",this.move.bind(this)),this.inputManager.on("restart",this.restart.bind(this)),this.inputManager.on("keepPlaying",this.keepPlaying.bind(this)),this.setup()}!function(e,t){var i,n;i="./2048/main.min.css",(n=t.createElement("link")).type="text/css",n.rel="stylesheet",n.href=i,t.getElementsByTagName("head")[0].appendChild(n),t.getElementById("small-game").innerHTML='<div class="container"><div class="heading"><h1 class="title">2048</h1><div class="scores-container"><div class="score-container">0</div><div class="best-container">0</div></div></div><div class="above-game"><p class="game-intro">Join the numbers and get to the <strong>2048 tile!</strong></p><a class="restart-button">New Game</a></div><div class="game-container"><div class="game-message"><p></p><div class="lower"><a class="keep-playing-button">Keep going</a><a class="retry-button">Try again</a></div></div><div class="grid-container"><div class="grid-row"><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div></div><div class="grid-row"><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div></div><div class="grid-row"><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div></div><div class="grid-row"><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div></div></div><div class="tile-container"></div></div></div>'}(window,document),Function.prototype.bind=Function.prototype.bind||function(t){var i=this;return function(e){e instanceof Array||(e=[e]),i.apply(t,e)}},function(){if(!(void 0===window.Element||"classList"in document.documentElement)){var e,t,i,n=Array.prototype,a=n.push,r=n.splice,o=n.join;s.prototype={add:function(e){this.contains(e)||(a.call(this,e),this.el.className=this.toString())},contains:function(e){return-1!=this.el.className.indexOf(e)},item:function(e){return this[e]||null},remove:function(e){if(this.contains(e)){for(var t=0;t<this.length&&this[t]!=e;t++);r.call(this,t,1),this.el.className=this.toString()}},toString:function(){return o.call(this," ")},toggle:function(e){return this.contains(e)?this.remove(e):this.add(e),this.contains(e)}},window.DOMTokenList=s,e=HTMLElement.prototype,t="classList",i=function(){return new s(this)},Object.defineProperty?Object.defineProperty(e,t,{get:i}):e.__defineGetter__(t,i)}function s(e){for(var t=(this.el=e).className.replace(/^\s+|\s+$/g,"").split(/\s+/),i=0;i<t.length;i++)a.call(this,t[i])}}(),function(){for(var a=0,e=["webkit","moz"],t=0;t<e.length&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[e[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[t]+"CancelAnimationFrame"]||window[e[t]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var t=(new Date).getTime(),i=Math.max(0,16-(t-a)),n=window.setTimeout(function(){e(t+i)},i);return a=t+i,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),KeyboardInputManager.prototype.on=function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)},KeyboardInputManager.prototype.emit=function(e,t){var i=this.events[e];i&&i.forEach(function(e){e(t)})},KeyboardInputManager.prototype.listen=function(){var s,l,c=this,n={38:0,39:1,40:2,37:3,75:0,76:1,74:2,72:3,87:0,68:1,83:2,65:3};document.addEventListener("keydown",function(e){var t=e.altKey||e.ctrlKey||e.metaKey||e.shiftKey,i=n[e.which];t||void 0!==i&&(e.preventDefault(),c.emit("move",i)),t||82!==e.which||c.restart.call(c,e)}),this.bindButtonPress(".retry-button",this.restart),this.bindButtonPress(".restart-button",this.restart),this.bindButtonPress(".keep-playing-button",this.keepPlaying);var e=document.getElementsByClassName("game-container")[0];e.addEventListener(this.eventTouchstart,function(e){!window.navigator.msPointerEnabled&&1<e.touches.length||1<e.targetTouches.length||(l=window.navigator.msPointerEnabled?(s=e.pageX,e.pageY):(s=e.touches[0].clientX,e.touches[0].clientY),e.preventDefault())}),e.addEventListener(this.eventTouchmove,function(e){e.preventDefault()}),e.addEventListener(this.eventTouchend,function(e){if(!(!window.navigator.msPointerEnabled&&0<e.touches.length||0<e.targetTouches.length)){var t,i;i=window.navigator.msPointerEnabled?(t=e.pageX,e.pageY):(t=e.changedTouches[0].clientX,e.changedTouches[0].clientY);var n=t-s,a=Math.abs(n),r=i-l,o=Math.abs(r);10<Math.max(a,o)&&c.emit("move",o<a?0<n?1:3:0<r?2:0)}})},KeyboardInputManager.prototype.restart=function(e){e.preventDefault(),this.emit("restart")},KeyboardInputManager.prototype.keepPlaying=function(e){e.preventDefault(),this.emit("keepPlaying")},KeyboardInputManager.prototype.bindButtonPress=function(e,t){var i=document.querySelector(e);i.addEventListener("click",t.bind(this)),i.addEventListener(this.eventTouchend,t.bind(this))},HTMLActuator.prototype.actuate=function(e,t){var i=this;window.requestAnimationFrame(function(){i.clearContainer(i.tileContainer),e.cells.forEach(function(e){e.forEach(function(e){e&&i.addTile(e)})}),i.updateScore(t.score),i.updateBestScore(t.bestScore),t.terminated&&(t.over?i.message(!1):t.won&&i.message(!0))})},HTMLActuator.prototype.continueGame=function(){this.clearMessage()},HTMLActuator.prototype.clearContainer=function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},HTMLActuator.prototype.addTile=function(e){var t=this,i=document.createElement("div"),n=document.createElement("div"),a=e.previousPosition||{x:e.x,y:e.y},r=this.positionClass(a),o=["tile","tile-"+e.value,r];2048<e.value&&o.push("tile-super"),this.applyClasses(i,o),n.classList.add("tile-inner"),n.textContent=e.value,e.previousPosition?window.requestAnimationFrame(function(){o[2]=t.positionClass({x:e.x,y:e.y}),t.applyClasses(i,o)}):e.mergedFrom?(o.push("tile-merged"),this.applyClasses(i,o),e.mergedFrom.forEach(function(e){t.addTile(e)})):(o.push("tile-new"),this.applyClasses(i,o)),i.appendChild(n),this.tileContainer.appendChild(i)},HTMLActuator.prototype.applyClasses=function(e,t){e.setAttribute("class",t.join(" "))},HTMLActuator.prototype.normalizePosition=function(e){return{x:e.x+1,y:e.y+1}},HTMLActuator.prototype.positionClass=function(e){return"tile-position-"+(e=this.normalizePosition(e)).x+"-"+e.y},HTMLActuator.prototype.updateScore=function(e){this.clearContainer(this.scoreContainer);var t=e-this.score;if(this.score=e,this.scoreContainer.textContent=this.score,0<t){var i=document.createElement("div");i.classList.add("score-addition"),i.textContent="+"+t,this.scoreContainer.appendChild(i)}},HTMLActuator.prototype.updateBestScore=function(e){this.bestContainer.textContent=e},HTMLActuator.prototype.message=function(e){var t=e?"game-won":"game-over",i=e?"You win!":"Game over!";this.messageContainer.classList.add(t),this.messageContainer.getElementsByTagName("p")[0].textContent=i},HTMLActuator.prototype.clearMessage=function(){this.messageContainer.classList.remove("game-won"),this.messageContainer.classList.remove("game-over")},Grid.prototype.empty=function(){for(var e=[],t=0;t<this.size;t++)for(var i=e[t]=[],n=0;n<this.size;n++)i.push(null);return e},Grid.prototype.fromState=function(e){for(var t=[],i=0;i<this.size;i++)for(var n=t[i]=[],a=0;a<this.size;a++){var r=e[i][a];n.push(r?new Tile(r.position,r.value):null)}return t},Grid.prototype.randomAvailableCell=function(){var e=this.availableCells();if(e.length)return e[Math.floor(Math.random()*e.length)]},Grid.prototype.availableCells=function(){var n=[];return this.eachCell(function(e,t,i){i||n.push({x:e,y:t})}),n},Grid.prototype.eachCell=function(e){for(var t=0;t<this.size;t++)for(var i=0;i<this.size;i++)e(t,i,this.cells[t][i])},Grid.prototype.cellsAvailable=function(){return!!this.availableCells().length},Grid.prototype.cellAvailable=function(e){return!this.cellOccupied(e)},Grid.prototype.cellOccupied=function(e){return!!this.cellContent(e)},Grid.prototype.cellContent=function(e){return this.withinBounds(e)?this.cells[e.x][e.y]:null},Grid.prototype.insertTile=function(e){this.cells[e.x][e.y]=e},Grid.prototype.removeTile=function(e){this.cells[e.x][e.y]=null},Grid.prototype.withinBounds=function(e){return 0<=e.x&&e.x<this.size&&0<=e.y&&e.y<this.size},Grid.prototype.serialize=function(){for(var e=[],t=0;t<this.size;t++)for(var i=e[t]=[],n=0;n<this.size;n++)i.push(this.cells[t][n]?this.cells[t][n].serialize():null);return{size:this.size,cells:e}},Tile.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},Tile.prototype.updatePosition=function(e){this.x=e.x,this.y=e.y},Tile.prototype.serialize=function(){return{position:{x:this.x,y:this.y},value:this.value}},window.fakeStorage={_data:{},setItem:function(e,t){return this._data[e]=String(t)},getItem:function(e){return this._data.hasOwnProperty(e)?this._data[e]:void 0},removeItem:function(e){return delete this._data[e]},clear:function(){return this._data={}}},LocalStorageManager.prototype.localStorageSupported=function(){try{var e=window.localStorage;return e.setItem("test","1"),e.removeItem("test"),!0}catch(e){return!1}},LocalStorageManager.prototype.getBestScore=function(){return this.storage.getItem(this.bestScoreKey)||0},LocalStorageManager.prototype.setBestScore=function(e){this.storage.setItem(this.bestScoreKey,e)},LocalStorageManager.prototype.getGameState=function(){var e=this.storage.getItem(this.gameStateKey);return e?JSON.parse(e):null},LocalStorageManager.prototype.setGameState=function(e){this.storage.setItem(this.gameStateKey,JSON.stringify(e))},LocalStorageManager.prototype.clearGameState=function(){this.storage.removeItem(this.gameStateKey)},GameManager.prototype.restart=function(){this.storageManager.clearGameState(),this.actuator.continueGame(),this.setup()},GameManager.prototype.keepPlaying=function(){this.keepPlaying=!0,this.actuator.continueGame()},GameManager.prototype.isGameTerminated=function(){return this.over||this.won&&!this.keepPlaying},GameManager.prototype.setup=function(){var e=this.storageManager.getGameState();e?(this.grid=new Grid(e.grid.size,e.grid.cells),this.score=e.score,this.over=e.over,this.won=e.won,this.keepPlaying=e.keepPlaying):(this.grid=new Grid(this.size),this.score=0,this.over=!1,this.won=!1,this.keepPlaying=!1,this.addStartTiles()),this.actuate()},GameManager.prototype.addStartTiles=function(){for(var e=0;e<this.startTiles;e++)this.addRandomTile()},GameManager.prototype.addRandomTile=function(){if(this.grid.cellsAvailable()){var e=Math.random()<.9?2:4,t=new Tile(this.grid.randomAvailableCell(),e);this.grid.insertTile(t)}},GameManager.prototype.actuate=function(){this.storageManager.getBestScore()<this.score&&this.storageManager.setBestScore(this.score),this.over?this.storageManager.clearGameState():this.storageManager.setGameState(this.serialize()),this.actuator.actuate(this.grid,{score:this.score,over:this.over,won:this.won,bestScore:this.storageManager.getBestScore(),terminated:this.isGameTerminated()})},GameManager.prototype.serialize=function(){return{grid:this.grid.serialize(),score:this.score,over:this.over,won:this.won,keepPlaying:this.keepPlaying}},GameManager.prototype.prepareTiles=function(){this.grid.eachCell(function(e,t,i){i&&(i.mergedFrom=null,i.savePosition())})},GameManager.prototype.moveTile=function(e,t){this.grid.cells[e.x][e.y]=null,(this.grid.cells[t.x][t.y]=e).updatePosition(t)},GameManager.prototype.move=function(e){var r=this;if(!this.isGameTerminated()){var o,s,l=this.getVector(e),t=this.buildTraversals(l),c=!1;this.prepareTiles(),t.x.forEach(function(a){t.y.forEach(function(e){if(o={x:a,y:e},s=r.grid.cellContent(o)){var t=r.findFarthestPosition(o,l),i=r.grid.cellContent(t.next);if(i&&i.value===s.value&&!i.mergedFrom){var n=new Tile(t.next,2*s.value);n.mergedFrom=[s,i],r.grid.insertTile(n),r.grid.removeTile(s),s.updatePosition(t.next),r.score+=n.value,2048===n.value&&(r.won=!0)}else r.moveTile(s,t.farthest);r.positionsEqual(o,s)||(c=!0)}})}),c&&(this.addRandomTile(),this.movesAvailable()||(this.over=!0),this.actuate())}},GameManager.prototype.getVector=function(e){return{0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}}[e]},GameManager.prototype.buildTraversals=function(e){for(var t={x:[],y:[]},i=0;i<this.size;i++)t.x.push(i),t.y.push(i);return 1===e.x&&(t.x=t.x.reverse()),1===e.y&&(t.y=t.y.reverse()),t},GameManager.prototype.findFarthestPosition=function(e,t){for(var i;e={x:(i=e).x+t.x,y:i.y+t.y},this.grid.withinBounds(e)&&this.grid.cellAvailable(e););return{farthest:i,next:e}},GameManager.prototype.movesAvailable=function(){return this.grid.cellsAvailable()||this.tileMatchesAvailable()},GameManager.prototype.tileMatchesAvailable=function(){for(var e,t=0;t<this.size;t++)for(var i=0;i<this.size;i++)if(e=this.grid.cellContent({x:t,y:i}))for(var n=0;n<4;n++){var a=this.getVector(n),r={x:t+a.x,y:i+a.y},o=this.grid.cellContent(r);if(o&&o.value===e.value)return!0}return!1},GameManager.prototype.positionsEqual=function(e,t){return e.x===t.x&&e.y===t.y},window.requestAnimationFrame(function(){new GameManager(4,KeyboardInputManager,HTMLActuator,LocalStorageManager)});
